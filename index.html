<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky blue like Gemini
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#131314', // Gemini Dark
                            surface: '#1e1f20',
                            border: '#444746'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS for Scrollbars & Animations -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Fira+Code:wght@400&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #444746; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Loader */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; color: #555; font-weight: 500;
        }
        .dark #loading { background: #131314; color: #e3e3e3; }
        
        /* Markdown Styles */
        .prose pre { background: #1e1e1e !important; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .prose code { color: #eb5757; background: rgba(135,131,120,0.15); padding: 0.1em 0.3em; border-radius: 3px; font-size: 0.9em; }
        .prose pre code { color: inherit; background: transparent; padding: 0; }
        .dark .prose code { color: #ff7b72; background: rgba(255,255,255,0.1); }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        
        /* Cursor Blink */
        .cursor-blink::after {
            content: 'â–‹';
            display: inline-block;
            animation: blink 1s step-end infinite;
            margin-left: 2px;
            color: #0ea5e9;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* Mobile Height Fix */
        .h-dvh { height: 100dvh; }
    </style>
</head>
<body class="bg-white dark:bg-dark-bg text-slate-800 dark:text-gray-200 transition-colors duration-200 overflow-hidden">

    <!-- FALLBACK LOADER -->
    <div id="loading">
        <div class="flex flex-col items-center gap-4">
            <svg class="animate-spin h-8 w-8 text-brand-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Initializing Interface...</span>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app" class="flex h-dvh w-full hidden opacity-0 transition-opacity duration-500">
        
        <!-- SIDEBAR OVERLAY (Mobile) -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden glass-effect"></div>

        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed lg:relative z-30 w-72 h-full bg-gray-50 dark:bg-dark-surface border-r border-gray-200 dark:border-dark-border transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
            
            <!-- Sidebar Header -->
            <div class="p-4 flex items-center justify-between">
                <button onclick="createNewChat()" class="flex-1 flex items-center gap-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm font-medium py-3 px-4 rounded-xl transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    New Chat
                </button>
                <button onclick="toggleSidebar()" class="lg:hidden ml-2 p-2 text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Chat History List -->
            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-history-list">
                <!-- Chat items injected here -->
            </div>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-gray-200 dark:border-dark-border">
                <button onclick="openSettings()" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    Settings
                </button>
                <button onclick="toggleTheme()" class="w-full flex items-center gap-3 px-3 py-2 mt-1 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <svg id="theme-icon-moon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    <svg id="theme-icon-sun" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                    <span id="theme-text">Dark Mode</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-dark-bg relative">
            
            <!-- Mobile Header -->
            <div class="lg:hidden flex items-center p-3 border-b border-gray-200 dark:border-dark-border bg-white dark:bg-dark-bg sticky top-0 z-10">
                <button onclick="toggleSidebar()" class="p-2 -ml-2 text-gray-600 dark:text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <span class="ml-2 font-medium text-lg" id="mobile-header-title">New Chat</span>
            </div>

            <!-- Messages Area -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 pb-32 space-y-6 scroll-smooth">
                <!-- Welcome Empty State -->
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center p-6 opacity-0">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-cyan-600 rounded-full mb-6 animate-pulse"></div>
                    <h1 class="text-3xl font-semibold mb-2 bg-gradient-to-r from-blue-500 to-cyan-500 bg-clip-text text-transparent">Hello, Human</h1>
                    <p class="text-gray-500 dark:text-gray-400 max-w-md">How can I help you today? Configure your API key in settings to get started.</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-white via-white to-transparent dark:from-dark-bg dark:via-dark-bg p-4 pb-6 pt-10">
                <div class="max-w-3xl mx-auto relative bg-gray-100 dark:bg-dark-surface rounded-3xl border border-transparent focus-within:border-gray-300 dark:focus-within:border-gray-600 focus-within:shadow-md transition-all">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Message AI..." 
                        class="w-full bg-transparent border-0 focus:ring-0 resize-none py-3.5 pl-5 pr-12 max-h-48 text-gray-800 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"
                        oninput="autoResize(this)"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                    
                    <button id="send-btn" onclick="sendMessage()" class="absolute right-2 bottom-2 p-2 bg-brand-600 hover:bg-brand-500 text-white rounded-full disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                        <svg class="w-5 h-5 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                    </button>
                </div>
                <div class="text-center mt-2 text-xs text-gray-400 dark:text-gray-500">
                    AI can make mistakes. Verify important info.
                </div>
            </div>
        </main>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white dark:bg-dark-surface rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-dark-border">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4">Settings</h2>
                
                <div class="space-y-4">
                    <!-- API Key -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">OpenRouter API Key</label>
                        <input type="password" id="setting-api-key" placeholder="sk-or-..." class="w-full p-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-[#252627] focus:ring-2 focus:ring-brand-500 outline-none">
                        <p class="text-xs text-gray-500 mt-1">Key is stored locally in your browser.</p>
                    </div>

                    <!-- Model -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Model Name</label>
                        <input type="text" id="setting-model" value="deepseek/deepseek-r1:free" class="w-full p-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-[#252627] focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>

                    <!-- System Prompt -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">System Instructions</label>
                        <textarea id="setting-system" rows="3" class="w-full p-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-[#252627] focus:ring-2 focus:ring-brand-500 outline-none text-sm" placeholder="You are a helpful assistant..."></textarea>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="closeSettings()" class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-brand-600 hover:bg-brand-500 text-white rounded-lg font-medium">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const DEFAULT_MODEL = "deepseek/deepseek-r1:free";
        const DEFAULT_SYSTEM = "You are a helpful, smart AI assistant. Answer concisely and accurately using Markdown.";
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";

        // --- STATE MANAGEMENT ---
        const state = {
            chats: JSON.parse(localStorage.getItem('chats')) || {},
            currentChatId: null,
            settings: JSON.parse(localStorage.getItem('settings')) || {
                apiKey: "",
                model: DEFAULT_MODEL,
                systemPrompt: DEFAULT_SYSTEM,
                theme: 'light' // 'light' or 'dark'
            },
            isGenerating: false,
            abortController: null
        };

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app'),
            loader: document.getElementById('loading'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            chatList: document.getElementById('chat-history-list'),
            msgContainer: document.getElementById('messages-container'),
            welcome: document.getElementById('welcome-screen'),
            input: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            settingsModal: document.getElementById('settings-modal'),
            inputs: {
                apiKey: document.getElementById('setting-api-key'),
                model: document.getElementById('setting-model'),
                system: document.getElementById('setting-system')
            },
            themeText: document.getElementById('theme-text'),
            iconSun: document.getElementById('theme-icon-sun'),
            iconMoon: document.getElementById('theme-icon-moon'),
            mobileTitle: document.getElementById('mobile-header-title')
        };

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => {
            // Setup Marked
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                    return highlight.highlight(code, { language }).value;
                },
                langPrefix: 'hljs language-',
                breaks: true // convert \n to <br>
            });

            // Apply Theme
            applyTheme(state.settings.theme);

            // Load Data
            renderChatList();
            
            // If no chats, create one
            if (Object.keys(state.chats).length === 0) {
                createNewChat(false); // Don't focus input yet
            } else {
                // Load most recent
                const lastId = Object.keys(state.chats).pop();
                loadChat(lastId);
            }

            // Reveal App
            setTimeout(() => {
                els.loader.style.display = 'none';
                els.app.classList.remove('hidden');
                setTimeout(() => els.app.classList.remove('opacity-0'), 50);
                els.welcome.classList.remove('opacity-0');
            }, 800);
        });

        // --- THEME HANDLING ---
        function applyTheme(theme) {
            const html = document.documentElement;
            if (theme === 'dark') {
                html.classList.add('dark');
                els.iconSun.classList.add('hidden');
                els.iconMoon.classList.remove('hidden');
                els.themeText.innerText = "Light Mode";
            } else {
                html.classList.remove('dark');
                els.iconSun.classList.remove('hidden');
                els.iconMoon.classList.add('hidden');
                els.themeText.innerText = "Dark Mode";
            }
        }

        function toggleTheme() {
            state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark';
            applyTheme(state.settings.theme);
            saveLocalSettings();
        }

        // --- SETTINGS MANAGEMENT ---
        function openSettings() {
            els.inputs.apiKey.value = state.settings.apiKey || '';
            els.inputs.model.value = state.settings.model || DEFAULT_MODEL;
            els.inputs.system.value = state.settings.systemPrompt || DEFAULT_SYSTEM;
            els.settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            els.settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            state.settings.apiKey = els.inputs.apiKey.value.trim();
            state.settings.model = els.inputs.model.value.trim();
            state.settings.systemPrompt = els.inputs.system.value.trim();
            saveLocalSettings();
            closeSettings();
            alert("Settings saved!");
        }

        function saveLocalSettings() {
            localStorage.setItem('settings', JSON.stringify(state.settings));
        }

        // --- CHAT MANAGEMENT ---
        function createNewChat(focus = true) {
            const id = Date.now().toString();
            state.chats[id] = {
                id: id,
                title: "New Chat",
                messages: [],
                timestamp: Date.now()
            };
            saveChats();
            renderChatList();
            loadChat(id);
            if (window.innerWidth < 1024) toggleSidebar(false); // Close sidebar on mobile
            if (focus) els.input.focus();
        }

        function loadChat(id) {
            state.currentChatId = id;
            const chat = state.chats[id];
            
            // UI Updates
            renderMessages(chat.messages);
            highlightActiveChat(id);
            els.mobileTitle.innerText = chat.title;

            // Show/Hide Welcome
            if (chat.messages.length === 0) {
                els.welcome.style.display = 'flex';
            } else {
                els.welcome.style.display = 'none';
            }
            
            // Scroll to bottom
            scrollToBottom();
        }

        function deleteChat(id, e) {
            e.stopPropagation();
            if(!confirm("Delete this chat?")) return;
            
            delete state.chats[id];
            saveChats();
            renderChatList();
            
            if (state.currentChatId === id) {
                const remaining = Object.keys(state.chats);
                if (remaining.length > 0) loadChat(remaining[remaining.length - 1]);
                else createNewChat();
            }
        }

        function renameChat(id, newTitle) {
            if (state.chats[id]) {
                state.chats[id].title = newTitle;
                saveChats();
                renderChatList();
                if(state.currentChatId === id) els.mobileTitle.innerText = newTitle;
            }
        }

        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(state.chats));
        }

        // --- RENDERING ---
        function renderChatList() {
            els.chatList.innerHTML = '';
            const sortedIds = Object.keys(state.chats).sort((a, b) => state.chats[b].timestamp - state.chats[a].timestamp);

            sortedIds.forEach(id => {
                const chat = state.chats[id];
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-lg cursor-pointer text-sm mb-1 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${id === state.currentChatId ? 'bg-blue-100 dark:bg-gray-800 text-brand-600 dark:text-blue-400 font-medium' : 'text-gray-700 dark:text-gray-300'}`;
                div.onclick = () => loadChat(id);
                
                div.innerHTML = `
                    <div class="truncate flex-1 pr-2">${chat.title}</div>
                    <div class="hidden group-hover:flex items-center gap-1">
                        <button onclick="event.stopPropagation(); const t = prompt('Rename:', '${chat.title}'); if(t) renameChat('${id}', t)" class="p-1 hover:text-blue-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                        <button onclick="deleteChat('${id}', event)" class="p-1 hover:text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                    </div>
                `;
                els.chatList.appendChild(div);
            });
        }

        function highlightActiveChat(id) {
            renderChatList(); // Simple re-render to update classes
        }

        function renderMessages(messages) {
            // Keep welcome screen if needed, else clear non-welcome
            Array.from(els.msgContainer.children).forEach(child => {
                if (child.id !== 'welcome-screen') child.remove();
            });

            messages.forEach(msg => {
                appendMessageToDOM(msg.role, msg.content, false);
            });
        }

        function appendMessageToDOM(role, content, animate = false) {
            const isUser = role === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `w-full flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] lg:max-w-[70%] rounded-2xl px-5 py-3.5 text-base shadow-sm ${
                isUser 
                ? 'bg-[#e0f2fe] dark:bg-[#1c3a4d] text-gray-900 dark:text-gray-100 rounded-br-sm' 
                : 'bg-white dark:bg-dark-surface border border-gray-100 dark:border-dark-border text-gray-800 dark:text-gray-100 rounded-bl-sm'
            }`;

            // Content processing
            if (isUser) {
                bubble.textContent = content; // User text is raw
            } else {
                bubble.classList.add('prose', 'dark:prose-invert', 'max-w-none');
                if (animate) {
                    bubble.classList.add('cursor-blink'); // Blinking cursor for streaming
                }
                bubble.innerHTML = marked.parse(content);
            }

            wrapper.appendChild(bubble);
            els.msgContainer.appendChild(wrapper);
            return { wrapper, bubble };
        }

        // --- INPUT HANDLING ---
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            els.sendBtn.disabled = !textarea.value.trim();
            els.sendBtn.style.opacity = textarea.value.trim() ? '1' : '0.5';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function scrollToBottom() {
            els.msgContainer.scrollTop = els.msgContainer.scrollHeight;
        }

        function toggleSidebar(force) {
            const isHidden = els.sidebar.classList.contains('-translate-x-full');
            const show = force !== undefined ? force : isHidden;
            
            if (show) {
                els.sidebar.classList.remove('-translate-x-full');
                els.sidebarOverlay.classList.remove('hidden');
            } else {
                els.sidebar.classList.add('-translate-x-full');
                els.sidebarOverlay.classList.add('hidden');
            }
        }

        // --- CORE AI LOGIC (STREAMING) ---
        async function sendMessage() {
            if (state.isGenerating) return;

            const text = els.input.value.trim();
            if (!text) return;

            if (!state.settings.apiKey) {
                alert("Please set your OpenRouter API Key in Settings first.");
                openSettings();
                return;
            }

            // 1. UI Reset
            els.input.value = '';
            els.input.style.height = 'auto';
            els.sendBtn.disabled = true;
            els.welcome.style.display = 'none';

            // 2. Add User Message
            const currentChat = state.chats[state.currentChatId];
            currentChat.messages.push({ role: 'user', content: text });
            
            // Auto-rename chat if it's the first message
            if (currentChat.messages.length === 1) {
                currentChat.title = text.slice(0, 30) + (text.length > 30 ? '...' : '');
                els.mobileTitle.innerText = currentChat.title;
                saveChats();
                renderChatList();
            }

            appendMessageToDOM('user', text);
            scrollToBottom();

            // 3. Prepare AI Placeholder
            state.isGenerating = true;
            const { bubble } = appendMessageToDOM('assistant', '', true); // Empty bubbling with cursor
            let aiContent = "";

            // 4. API Request
            state.abortController = new AbortController();

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.settings.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, // OpenRouter requirement
                        "X-Title": "Universal AI Chat"
                    },
                    body: JSON.stringify({
                        model: state.settings.model,
                        messages: [
                            { role: "system", content: state.settings.systemPrompt },
                            ...currentChat.messages
                        ],
                        stream: true
                    }),
                    signal: state.abortController.signal
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "API Error");
                }

                // 5. Streaming Loop
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.replace('data: ', '');
                            if (dataStr === '[DONE]') break;
                            
                            try {
                                const data = JSON.parse(dataStr);
                                const token = data.choices[0]?.delta?.content || "";
                                
                                if (token) {
                                    aiContent += token;
                                    // Live Render Markdown (Note: can be expensive, but effective for this scale)
                                    // Optimized: Update innerHTML directly
                                    bubble.innerHTML = marked.parse(aiContent);
                                    scrollToBottom();
                                }
                            } catch (e) {
                                console.error("Parse Error", e);
                            }
                        }
                    }
                }

                // 6. Finalize
                currentChat.messages.push({ role: 'assistant', content: aiContent });
                saveChats();

            } catch (error) {
                if (error.name !== 'AbortError') {
                    bubble.innerHTML += `<p class="text-red-500 text-sm mt-2">Error: ${error.message}</p>`;
                    currentChat.messages.push({ role: 'assistant', content: aiContent + `\n[Error: ${error.message}]` });
                }
            } finally {
                state.isGenerating = false;
                bubble.classList.remove('cursor-blink');
                
                // Re-highlight code blocks after full render
                bubble.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }
    </script>
</body>
</html>
```
